@model WEBVANDAP.ViewModels.CheckoutViewModel
@using WEBVANDAP.Models

@{
    ViewBag.Title = "Thanh Toán Đơn Hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";

    List<CartItem> cartItems = ViewBag.CartItems as List<CartItem> ?? new List<CartItem>();
    List<Address> userAddresses = ViewBag.Addresses as List<Address> ?? new List<Address>();

    Address defaultAddress = userAddresses.FirstOrDefault(a => a.IsDefault == true) ?? userAddresses.FirstOrDefault();

    if (defaultAddress != null && Model.SelectedAddressId == null)
    {
        Model.ShippingFullName = defaultAddress.FullName;
        Model.ShippingPhone = defaultAddress.Phone;
        Model.ShippingStreet = defaultAddress.Street;
        Model.SelectedAddressId = defaultAddress.Id;
    }
}

<style>
    footer {
        display: none;
    }

    /* Custom Styles for Checkout */
    .checkout-container {
        background-color: #f9f9f9;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
    }

        .checkout-container .card {
            margin-bottom: 20px;
        }

        .checkout-container h5 {
            color: #333;
            font-weight: bold;
        }

    .checkout-summary {
        font-size: 18px;
        font-weight: 600;
    }

        .checkout-summary .price {
            font-size: 22px;
            color: #e74c3c;
        }

    .btn-checkout {
        background-color: #e74c3c;
        color: white;
        font-weight: bold;
        padding: 15px;
        border-radius: 5px;
        width: 100%;
    }

        .btn-checkout:hover {
            background-color: #c0392b;
        }

    .back-to-cart {
        background-color: #bdc3c7;
        color: white;
        font-weight: bold;
        padding: 12px;
        border-radius: 5px;
        width: 100%;
    }

        .back-to-cart:hover {
            background-color: #95a5a6;
        }

    .form-check-label {
        font-size: 16px;
    }

    .form-select {
        font-size: 16px;
    }

    .shipping-address {
        margin-top: 20px;
    }

    /* Ẩn form địa chỉ mới mặc định */
    #new-address-fields {
        display: none;
    }

    /* Tùy chỉnh scroll bar cho danh sách sản phẩm */
    .checkout-products::-webkit-scrollbar {
        width: 6px;
    }

    .checkout-products::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .checkout-products::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
    }

        .checkout-products::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
</style>

<div class="container my-5">
    <div class="checkout-container">
        <h2 class="text-center fw-bold mb-4">Hoàn Tất Đơn Hàng</h2>
        <hr />

        @using (Html.BeginForm("PlaceOrder", "Order", FormMethod.Post, new { id = "checkoutForm" }))
        {
            @Html.AntiForgeryToken()

            @* Hiển thị validation nếu có lỗi *@
            if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger">
                    @Html.ValidationSummary(false, "", new { @class = "mb-0" })
                </div>
            }

            <div class="row g-4">

                <!-- Left Column (Shipping Address & Payment) -->
                <div class="col-lg-8">
                    <!-- Shipping Address -->
                    <div class="card shadow-sm border-0 p-4">
                        <h5 class="fw-bold text-primary mb-3"><i class="fa fa-map-marker-alt me-2"></i> Địa Chỉ Giao Hàng</h5>

                        @if (userAddresses.Any())
                        {
                            <p class="small text-muted">Chọn địa chỉ đã lưu hoặc nhập địa chỉ mới.</p>

                            <div class="mb-3">
                                <label class="form-label small fw-bold">Địa chỉ đã lưu:</label>
                                @Html.DropDownListFor(m => m.SelectedAddressId,
                                    new SelectList(userAddresses, "Id", "Street", Model.SelectedAddressId),
                                    "--- Nhập Địa chỉ mới ---",
                                    new { @class = "form-select", id = "addressSelect" })
                            </div>
                        }

                        <!-- New Address Fields -->
                        <div id="new-address-fields">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    @Html.LabelFor(m => m.ShippingFullName, "Tên người nhận", new { @class = "form-label small fw-bold" })
                                    @Html.TextBoxFor(m => m.ShippingFullName, new { @class = "form-control", placeholder = "Ví dụ: Nguyễn Văn A", id = "ShippingFullName" })
                                    @Html.ValidationMessageFor(m => m.ShippingFullName, "", new { @class = "text-danger small" })
                                </div>
                                <div class="col-md-6">
                                    @Html.LabelFor(m => m.ShippingPhone, "Số điện thoại", new { @class = "form-label small fw-bold" })
                                    @Html.TextBoxFor(m => m.ShippingPhone, new { @class = "form-control", placeholder = "09x xxx xxxx", id = "ShippingPhone" })
                                    @Html.ValidationMessageFor(m => m.ShippingPhone, "", new { @class = "text-danger small" })
                                </div>
                                <div class="col-12">
                                    @Html.LabelFor(m => m.ShippingStreet, "Địa chỉ chi tiết", new { @class = "form-label small fw-bold" })
                                    @Html.TextBoxFor(m => m.ShippingStreet, new { @class = "form-control", placeholder = "Ví dụ: 123 Nguyễn Trãi, Phường B...", id = "ShippingStreet" })
                                    @Html.ValidationMessageFor(m => m.ShippingStreet, "", new { @class = "text-danger small" })
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="card shadow-sm border-0 p-4">
                        <h5 class="fw-bold text-primary mb-3"><i class="fa fa-money-bill-wave me-2"></i> Phương Thức Thanh Toán</h5>
                        <div class="form-check mb-2">
                            @Html.RadioButtonFor(m => m.PaymentMethod, "COD", new { @class = "form-check-input", id = "paymentCOD", @checked = (Model.PaymentMethod == "COD" || string.IsNullOrEmpty(Model.PaymentMethod)) })
                            <label class="form-check-label" for="paymentCOD">Thanh toán khi nhận hàng (COD)</label>
                        </div>
                        <div class="form-check">
                            @Html.RadioButtonFor(m => m.PaymentMethod, "Online", new { @class = "form-check-input", id = "paymentOnline", @disabled = "disabled" })
                            <label class="form-check-label" for="paymentOnline">Thanh toán Online (Thẻ/Ví điện tử) - *Đang phát triển*</label>
                        </div>
                        @Html.ValidationMessageFor(m => m.PaymentMethod, "", new { @class = "text-danger small" })
                    </div>

                    <!-- Order Notes -->
                    <div class="card shadow-sm border-0 p-4">
                        <div class="mb-3">

                            <label for="Notes" class="form-label fw-bold text-primary">
                                <i class="fa fa-sticky-note me-2"></i> Ghi Chú Đơn Hàng
                            </label>

                            @Html.TextAreaFor(m => m.Notes, new
                            {
                                @class = "form-control",
                                placeholder = "Yêu cầu về thời gian giao hàng, địa chỉ bổ sung...",
                                rows = "4",              // Chiều cao mặc định là 4 dòng
                                style = "resize: vertical;"  // QUAN TRỌNG: Chặn người dùng kéo giãn khung
                            })

                        </div>
                    </div>
                </div>

                <!-- Right Column (Order Summary) -->
                <div class="col-lg-4">
                    <div class="card shadow-lg border-0 p-4">
                        <h5 class="fw-bold mb-3">Sản Phẩm (@cartItems.Sum(ci => ci.Quantity))</h5>

                        <ul class="list-unstyled small mb-4 border-bottom pb-2 checkout-products" style="max-height: 250px; overflow-y: auto;">
                            @foreach (var item in cartItems)
                            {
                                string productName = item.Product?.Name ?? $"Sản phẩm #{item.ProductId}";
                                string defaultImageUrl = Url.Content("~/Content/ProductImages/no-image.png");
                                string imageUrl = Url.Content(item.Product?.ProductImages?.FirstOrDefault()?.Url ?? defaultImageUrl);

                                <li class="d-flex align-items-start mb-3 me-1">
                                    <img src="@imageUrl" alt="@productName"
                                         style="width:55px; height:55px; object-fit:cover; border-radius:8px; margin-right:12px; border: 1px solid #eee;" />
                                    <div class="flex-grow-1 pe-2">
                                        <div class="fw-semibold text-dark" style="line-height: 1.2;">@productName</div>
                                        <small class="text-muted">x @item.Quantity</small>
                                    </div>

                                    <div class="fw-bold text-end text-nowrap">
                                        @((item.UnitPrice * (item.Quantity ?? 0)).ToString("N0")) đ
                                    </div>
                                </li>
                            }
                        </ul>

                        <div class="d-flex justify-content-between mb-2">
                            <span>Tổng tiền hàng:</span>
                            <span class="fw-bold">@Model.CartTotal.ToString("N0") đ</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Phí vận chuyển:</span>
                            <span class="fw-bold text-success">@Model.ShippingFee.ToString("N0") đ</span>
                        </div>
                        <hr />
                        <div class="d-flex justify-content-between mb-4">
                            <span class="fs-5 fw-bold">TỔNG CỘNG:</span>
                            <span class="fs-4 fw-bolder text-danger">@Model.FinalTotal.ToString("N0") đ</span>
                        </div>

                        <button type="submit" class="btn btn-danger btn-lg fw-bold py-3 w-100">
                            HOÀN TẤT ĐẶT HÀNG
                        </button>

                        <a href="@Url.Action("Index", "Cart")" class="btn btn-outline-secondary mt-2 w-100">
                            ← Quay lại Giỏ hàng
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        function toggleNewAddressFields() {
            var selectedValue = $('#addressSelect').val();
            if (!selectedValue) { // "--- Nhập địa chỉ mới ---"
                $('#new-address-fields').slideDown();
            } else {
                $('#new-address-fields').slideUp();
            }
        }

        // Kiểm tra khi load trang
        toggleNewAddressFields();

        // Kiểm tra khi user đổi dropdown
        $('#addressSelect').change(function () {
            toggleNewAddressFields();
        });
    });
</script>
