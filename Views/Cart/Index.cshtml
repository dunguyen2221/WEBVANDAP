@model IEnumerable<WEBVANDAP.Models.CartItem>

@{
    ViewBag.Title = "Giỏ hàng - LogiT Shop";

    decimal subTotal = Model?.Sum(item => (item.Quantity ?? 0) * item.UnitPrice) ?? 0;
    int totalItems = Model?.Sum(item => item.Quantity ?? 0) ?? 0;

    decimal minOrderAmount = 40000;
    bool isEligibleForCheckout = subTotal >= minOrderAmount;

    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewBag.Title</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

    <style>
        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: #f9f9f9;
        }

        /* ========== Navbar ========== */
        .navbar {
            background-color: #fff;
        }

        /* ========== Giỏ hàng ========== */
        .cart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2rem;
        }

        .cart-list {
            flex: 1 1 60%;
            background-color: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            min-width: 350px;
        }

        .summary-card {
            flex: 1 1 30%;
            background-color: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            min-width: 280px;
            height: fit-content;
        }

        .cart-item-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .price {
            color: #d0021c;
            font-weight: 600;
        }

        .quantity-input {
            width: 55px;
            height: 30px;
            text-align: center;
            margin: 0 4px;
        }

        .quantity-btn {
            height: 30px;
            line-height: 1;
            padding: 0.25rem 0.5rem;
        }

        /* ========== Footer ========== */
        footer {
            background-color: #fff;
            border-top: 1px solid #ddd;
            padding: 40px 0;
            text-align: center;
            margin-top: 60px;
        }

        footer p {
            margin-bottom: 0;
            color: #666;
        }

        /* ========== Responsive ========== */
        @@media (max-width: 992px) {
            .cart-container {
                flex-direction: column;
                align-items: center;
            }

            .cart-list, .summary-card {
                width: 90%;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-danger d-flex align-items-center" href="@Url.Action("Index", "Home")">
                <img style="height: 35px;" src="@Url.Content("~/Content/IMG/logo.png")" alt="logo" class="me-2" />
                <span class="fs-4 fw-bold">LogiT</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 fw-semibold">
                    <li class="nav-item"><a class="nav-link" href="@Url.Action("Index", "Home")">TRANG CHỦ</a></li>
                    <li class="nav-item"><a class="nav-link" href="#footer-contact">LIÊN HỆ</a></li>
                </ul>
                <form class="d-flex">
                    <input class="form-control me-2" type="search" placeholder="Tìm kiếm..." />
                    <button class="btn btn-outline-dark" type="submit"><i class="bi bi-search"></i></button>
                </form>
            </div>
        </div>
    </nav>

    <!-- Giỏ hàng -->
    <div class="container my-5">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")" class="text-decoration-none">Trang chủ</a></li>
                <li class="breadcrumb-item active" aria-current="page">Giỏ hàng (@totalItems)</li>
            </ol>
        </nav>

        @if (Model == null || !Model.Any())
        {
            <div class="alert alert-info text-center">
                Giỏ hàng của bạn hiện đang trống.
                <a href="@Url.Action("Index", "Home")" class="alert-link">Tiếp tục mua sắm</a>.
            </div>
        }
        else
        {
            <div class="cart-container">
                <div class="cart-list">
                    <h5 class="fw-bold mb-4 border-bottom pb-2">Giỏ hàng của bạn</h5>

                    @foreach (var item in Model)
                    {
                        var qty = item.Quantity ?? 0;
                        var total = qty * item.UnitPrice;
                        string productName = item.Product?.Name ?? $"Sản phẩm #{item.ProductId}";
                        string defaultImageUrl = "~/Content/ProductImages/no-image.png";
                        string imageUrl = (item.Product?.ProductImages?.FirstOrDefault()?.Url) ?? defaultImageUrl;

                        <div class="cart-item d-flex align-items-center mb-4 border-bottom pb-3">
                            <img src="@Url.Content(imageUrl)" alt="@productName" class="cart-item-img border rounded me-3" />

                            <div class="flex-grow-1">
                                <h6 class="fw-semibold mb-1">@productName</h6>
                                <p class="price mb-0">@item.UnitPrice.ToString("N0") đ</p>
                            </div>

                            <div class="mx-3 d-flex align-items-center">
                                @using (Html.BeginForm("UpdateQuantity", "Cart", FormMethod.Post, new { @class = "d-flex align-items-center" }))
                                {
                                    @Html.Hidden("productId", item.ProductId)
                                    <button type="button" class="btn btn-sm btn-outline-secondary quantity-btn"
                                            onclick="this.form.quantity.stepDown(); this.form.submit();" @(qty <= 1 ? "disabled" : "")>
                                        -
                                    </button>
                                    <input type="number" name="quantity" class="form-control form-control-sm quantity-input"
                                           min="1" value="@qty" onchange="this.form.submit()" />
                                    <button type="button" class="btn btn-sm btn-outline-secondary quantity-btn"
                                            onclick="this.form.quantity.stepUp(); this.form.submit();">
                                        +
                                    </button>
                                }
                            </div>

                            <div class="fw-bold text-end" style="width: 120px;">@total.ToString("N0") đ</div>

                            <div class="ms-3">
                                @using (Html.BeginForm("RemoveFromCart", "Cart", FormMethod.Post))
                                {
                                    @Html.Hidden("productId", item.ProductId)
                                    <button type="submit" class="btn btn-outline-danger btn-sm"
                                            onclick="return confirm('Xóa sản phẩm này khỏi giỏ hàng?');">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                }
                            </div>
                        </div>
                    }

                    <div class="text-end mt-4">
                        @using (Html.BeginForm("RemoveAll", "Cart", FormMethod.Post))
                        {
                            <button type="submit" class="btn btn-danger btn-sm"
                                    onclick="return confirm('Bạn có chắc chắn muốn xóa tất cả sản phẩm khỏi giỏ hàng?');">
                                Xoá hết giỏ hàng
                            </button>
                        }
                    </div>
                </div>

                <!-- Tổng cộng -->
                <div class="summary-card">
                    <h5 class="fw-bold mb-4 border-bottom pb-2">Thông tin đơn hàng</h5>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fs-6 fw-bold">Tổng tiền:</span>
                        <span class="fs-4 fw-bold text-danger price">@subTotal.ToString("N0") đ</span>
                    </div>

                    <a href="@Url.Action("Checkout", "Order")"
                       class="btn btn-danger w-100 fw-bold fs-5 py-2 mb-3"
                       @(isEligibleForCheckout ? "" : "disabled")>
                        THANH TOÁN
                    </a>

                    <div class="alert alert-info p-3 d-flex align-items-start" style="background-color: #e6f7ff;">
                        <i class="bi bi-info-circle-fill fs-5 me-2 text-primary"></i>
                        <div>
                            <strong class="d-block mb-1">Chính sách mua hàng</strong>
                            <small>Chỉ thanh toán với đơn hàng trên <strong>@minOrderAmount.ToString("N0") đ</strong>.</small>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <footer id="footer-contact">
        <p>© 2025 LogiT Shop — All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
